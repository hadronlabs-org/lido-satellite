<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Sign demo</title>

    <style>
        .results {
            margin-top: 1rem;
        }

        .results p, .results a {
            margin: unset;
        }
    </style>
</head>

<body>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js" type="application/javascript"></script>

    <h1>EIP-712</h1>
    <h4>This demo describes how to sign structured data using EIP-712, and then apply this knowledge to create an EIP-2612 signature</h4>
    <label for="contract">GMP helper contract address, upload it on Goerli:</label><br>
    <input type="text" id="contract" name="contract" size="40" value="0xDC80000b002048Cf49420e1ED1Ae985Bc55994E6"/><br><br>
    <label for="amount">Amount of wstETH-wei to transfer:</label><br>
    <input type="text" id="amount" name="amount" size="20" value="42"/><br><br>
    <label for="nonce">Nonce, you can query it directy from wstETH contract for your account:</label><br>
    <input type="text" id="nonce" name="nonce" size="10" value="0"/><br><br>
    <button onclick="sign()">Sign demo</button>
    <div class="results" id="results"></div>
    <script>
        async function sign() {
            const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
            const owner = accounts[0];
            const wstEth = "0x6320cD32aA674d2898A68ec82e869385Fc5f7E2f";
            const wstEthName = "Wrapped liquid staked Ether 2.0";
            const goerliChainId = "5";
            const deadline = Math.floor(Date.now() / 1000) + 3600;
            const spender = document.getElementById("contract").value;
            const amount = document.getElementById("amount").value;
            const nonce = document.getElementById("nonce").value;

            const msgParams = JSON.stringify({
                types: {
                    EIP712Domain: [
                        {
                            name: "name",
                            type: "string"
                        },
                        {
                            name: "version",
                            type: "string"
                        },
                        {
                            name: "chainId",
                            type: "uint256"
                        },
                        {
                            name: "verifyingContract",
                            type: "address"
                        }
                    ],
                    Permit: [
                        {
                            name: "owner",
                            type: "address"
                        },
                        {
                            name: "spender",
                            type: "address"
                        },
                        {
                            name: "value",
                            type: "uint256"
                        },
                        {
                            name: "nonce",
                            type: "uint256"
                        },
                        {
                            name: "deadline",
                            type: "uint256"
                        }
                    ],
                },
                primaryType: "Permit",
                domain: {
                    name: wstEthName,
                    version: "1",
                    chainId: goerliChainId,
                    verifyingContract: wstEth,
                },
                message: {
                    owner,
                    spender,
                    value: amount,
                    nonce,
                    deadline,
                }
            });

            const results = document.getElementById("results");
            let child = results.lastElementChild;
            while (child) {
                results.removeChild(child);
                child = results.lastElementChild;
            }

            const userText = [];
            const result = await window.ethereum.request({
                method: 'eth_signTypedData_v4',
                params: [owner, msgParams],
                from: owner,
            });
            const r = result.substring(2, 2 + 64);
            const s = result.substring(2 + 64, 2 + 64 + 64);
            const v = parseInt(result.substring(2 + 64 + 64, 2 + 64 + 64 + 2), 16);

            userText.push("receiver = <any address on Neutron>");
            userText.push(`amount = ${amount}`);
            userText.push(`deadline = ${deadline}`);
            userText.push(`v = ${v}`);
            userText.push(`r = 0x${r}`);
            userText.push(`s = 0x${s}`);

            for (const text of userText) {
                const p = document.createElement("p");
                p.appendChild(document.createTextNode(text));
                results.appendChild(p);
            }
        }
    </script>

    <hr>
    <h1>Burn ETH</h1>
    <h4>This demo describes how to burn ETH via sending it to zero address</h4>
    <label for="burn_amount">Amount of ETH-wei to burn:</label><br>
    <input type="text" id="burn_amount" name="burn_amount" size="20" value="0x2a"/><br><br>
    <button onclick="burn()">Burn demo</button>
    <div class="results" id="burn_results"></div>
    <script>
        async function burn() {
            const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
            const owner = accounts[0];
            const burnAmount = document.getElementById("burn_amount").value;

            const burnResults = document.getElementById("burn_results");
            let child = burnResults.lastElementChild;
            while (child) {
                burnResults.removeChild(child);
                child = burnResults.lastElementChild;
            }

            const txhash = await window.ethereum.request({
                method: 'eth_sendTransaction',
                params: [
                    {
                        from: owner,
                        to: "0x0000000000000000000000000000000000000000",
                        value: burnAmount,
                    }
                ]
            });

            const a = document.createElement("a");
            a.textContent = `${txhash} on Görli Etherscan`;
            a.href = `https://goerli.etherscan.io/tx/${txhash}`;
            burnResults.appendChild(a);
        }
    </script>

    <hr>
    <h1>Query smart contract</h1>
    <h4>This demo describes how to query a smart contract, as an example reading nonce from wstETH</h4>
    <button onclick="query()">Query demo</button>
    <div class="results" id="query_results"></div>
    <script>
        async function query() {
            const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
            const owner = accounts[0];
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const signer = provider.getSigner(owner);
            const abi = [
                "function nonces(address _owner) public view returns (uint256)"
            ];
            const wstEthContract = new ethers.Contract("0x6320cD32aA674d2898A68ec82e869385Fc5f7E2f", abi, signer);

            const queryResults = document.getElementById("query_results");
            let child = queryResults.lastElementChild;
            while (child) {
                queryResults.removeChild(child);
                child = queryResults.lastElementChild;
            }

            const nonce = await wstEthContract.nonces(owner);

            const p = document.createElement("p");
            p.appendChild(document.createTextNode(`${owner} has a following nonce on wstETH: ${nonce.toString()}`));
            queryResults.appendChild(p);
        }
    </script>

    <hr>
    <h1>Execute smart contract</h1>
    <h4>This demo describes how to execute forward() function on GMP Helper (requires allowance)</h4>
    <p>In this example a following path is implemented: Ethereum → Axelar → Neutron → Terra → Neutron</p>
    <label for="forward_amount">Amount of wstETH-wei to transfer:</label><br>
    <input type="text" id="forward_amount" name="forward_amount" size="20" value="123000000"/><br><br>
    <label for="forward_ibc_fee">Amount of wstETH-wei to spend on IBC fee:</label><br>
    <input type="text" id="forward_ibc_fee" name="forward_ibc_fee" size="20" value="100000000"/><br><br>
    <label for="forward_axelar_fee">Amount of ETH-wei to spend on Axelar fee:</label><br>
    <input type="text" id="forward_axelar_fee" name="forward_axelar_fee" size="20" value="0x2386f26fc10000"/><br><br>
    <button onclick="execute_forward()">Execute demo: forward()</button>
    <div class="results" id="forward_results"></div>
    <script>
        async function execute_forward() {
            const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
            const owner = accounts[0];
            const abi = ["function forward(bytes calldata gmpPayload, uint256 amount, address gasRefundAddress) external payable returns (bool success)"];
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const signer = provider.getSigner(owner);
            const gmpHelper = new ethers.Contract("0xEA5b80cFBbB9A61367675446c62782f41892D632", abi, signer);

            const amount = document.getElementById("forward_amount").value;
            const ibcFee = document.getElementById("forward_ibc_fee").value;
            const axelarFee = document.getElementById("forward_axelar_fee").value;

            const forwardResults = document.getElementById("forward_results");
            let child = forwardResults.lastElementChild;
            while (child) {
                forwardResults.removeChild(child);
                child = forwardResults.lastElementChild;
            }

            // set to empty string to avoid using IBC hooks
            const memo = JSON.stringify({forward:{
                receiver: "neutron10kvpy9lt3lu24jd8rt9vewrnagpkq5e6r7vcfa",
                port: "transfer",
                channel: "channel-284",
            }});

            const payload = JSON.stringify({
                "wrap_and_send": {
                    "amount_to_swap_for_ibc_fee": ibcFee,
                    "astroport_swap_operations": [
                        {
                            "astro_swap": {
                                "ask_asset_info": {
                                    "native_token": {
                                        "denom": "ibc/F91EA2C0A23697A1048E08C2F787E3A58AC6F706A1CD2257A504925158CFC0F3"
                                    }
                                },
                                "offer_asset_info": {
                                    "native_token": {
                                        "denom": "factory/neutron1xdtwh5jr4zjx8g3zh29jud75c666wua7tsmum3ajm6ylf782etfs60dj2h/wstETH"
                                    }
                                }
                            }
                        },
                        {
                            "astro_swap": {
                                "ask_asset_info": {
                                    "native_token": {
                                        "denom": "ibc/C4CFF46FD6DE35CA4CF4CE031E643C8FDC9BA4B99AE598E9B0ED98FE3A2319F9"
                                    }
                                },
                                "offer_asset_info": {
                                    "native_token": {
                                        "denom": "ibc/F91EA2C0A23697A1048E08C2F787E3A58AC6F706A1CD2257A504925158CFC0F3"
                                    }
                                }
                            }
                        },
                        {
                            "astro_swap": {
                                "ask_asset_info": {
                                    "native_token": {
                                        "denom": "ibc/EFB00E728F98F0C4BBE8CA362123ACAB466EDA2826DC6837E49F4C1902F21BBA"
                                    }
                                },
                                "offer_asset_info": {
                                    "native_token": {
                                        "denom": "ibc/C4CFF46FD6DE35CA4CF4CE031E643C8FDC9BA4B99AE598E9B0ED98FE3A2319F9"
                                    }
                                }
                            }
                        },
                        {
                            "astro_swap": {
                                "ask_asset_info": {
                                    "native_token": {
                                        "denom": "ibc/584A4A23736884E0C198FD1EE932455A9357A492A7B94324E4A02B5628687831"
                                    }
                                },
                                "offer_asset_info": {
                                    "native_token": {
                                        "denom": "ibc/EFB00E728F98F0C4BBE8CA362123ACAB466EDA2826DC6837E49F4C1902F21BBA"
                                    }
                                }
                            }
                        },
                        {
                            "astro_swap": {
                                "ask_asset_info": {
                                    "native_token": {
                                        "denom": "untrn"
                                    }
                                },
                                "offer_asset_info": {
                                    "native_token": {
                                        "denom": "ibc/584A4A23736884E0C198FD1EE932455A9357A492A7B94324E4A02B5628687831"
                                    }
                                }
                            }
                        }
                    ],
                    "ibc_fee_denom": "untrn",
                    "ibc_memo": memo,
                    "receiver": "terra1c2qsse4duwxsg78xv9m96z08v9pacpaznqfz63",
                    "refund_address": "neutron10kvpy9lt3lu24jd8rt9vewrnagpkq5e6r7vcfa",
                    "source_channel": "channel-98",
                    "source_port": "transfer",
                    "timeout": 60000000000
                }
            });
            const versionedPayload = [0, 0, 0, 2, ...(new TextEncoder()).encode(payload)];
            const forwardTxUnsigned = await gmpHelper.populateTransaction.forward(
                versionedPayload,
                amount,
                "0x0000000000000000000000000000000000000000",
            );
            forwardTxUnsigned.value = "0x" + (+axelarFee).toString(16);
            const txHash = await window.ethereum.request({
                method: 'eth_sendTransaction',
                params: [forwardTxUnsigned],
            });
            console.log(txHash);

            const a = document.createElement("a");
            a.textContent = `${txHash} on Görli Etherscan`;
            a.href = `https://goerli.etherscan.io/tx/${txHash}`;
            forwardResults.appendChild(a);
        }
    </script>
</body>

</html>
